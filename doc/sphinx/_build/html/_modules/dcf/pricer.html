
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dcf.pricer &#8212; Derivate 0.1 [3 - Alpha] documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for dcf.pricer</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># dcf</span>
<span class="c1"># ---</span>
<span class="c1"># A Python library for generating discounted cashflows.</span>
<span class="c1">#</span>
<span class="c1"># Author:   sonntagsgesicht, based on a fork of Deutsche Postbank [pbrisk]</span>
<span class="c1"># Version:  0.6, copyright Wednesday, 22 December 2021</span>
<span class="c1"># Website:  https://github.com/sonntagsgesicht/dcf</span>
<span class="c1"># License:  Apache License 2.0 (see LICENSE file)</span>


<span class="kn">from</span> <span class="nn">.interestratecurve</span> <span class="kn">import</span> <span class="n">ZeroRateCurve</span><span class="p">,</span> <span class="n">CashRateCurve</span>
<span class="kn">from</span> <span class="nn">.cashflow</span> <span class="kn">import</span> <span class="n">CashFlowLegList</span>


<span class="k">def</span> <span class="nf">_simple_bracketing</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-13</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; find root by _simple_bracketing an interval</span>

<span class="sd">    :param callable func: function to find root</span>
<span class="sd">    :param float a: lower interval boundary</span>
<span class="sd">    :param float b: upper interval boundary</span>
<span class="sd">    :param float precision: max accepted error</span>
<span class="sd">    :rtype: tuple</span>
<span class="sd">    :return: :code:`(a, m, b)` of last recursion step</span>
<span class="sd">        with :code:`m = a + (b-a) *.5`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fa</span><span class="p">,</span> <span class="n">fb</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">func</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fb</span> <span class="o">&lt;</span> <span class="n">fa</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">fa</span><span class="p">,</span> <span class="n">fb</span> <span class="o">=</span> <span class="n">fb</span><span class="p">,</span> <span class="n">fa</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">fa</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="o">&lt;=</span> <span class="n">fb</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;_simple_bracketing function must be loc monotone &quot;</span> \
              <span class="s2">&quot;between </span><span class="si">%0.4f</span><span class="s2"> and </span><span class="si">%0.4f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;and _simple_bracketing 0. between  </span><span class="si">%0.4f</span><span class="s2"> and </span><span class="si">%0.4f</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fa</span><span class="p">,</span> <span class="n">fb</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">precision</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fb</span> <span class="o">-</span> <span class="n">fa</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">precision</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span>

    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_simple_bracketing</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_present_value</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">discount_curve</span><span class="p">,</span>
                      <span class="n">valuation_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_value_date</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; calculates the present value by discounting cashflows</span>

<span class="sd">    :param cashflow_list: list of cashflows</span>
<span class="sd">    :param discount_curve: discount factors are obtained from this curve</span>
<span class="sd">    :param valuation_date: date to discount to</span>
<span class="sd">    :param include_value_date: (bool) to decide if cashflows</span>
<span class="sd">        at **valuation_date** are included,</span>
<span class="sd">        (optional with default *True*)</span>
<span class="sd">    :return: `float` - as the sum of all discounted future cashflows</span>

<span class="sd">    Let $cf_1 \dots cf_n$ be the list of cashflows</span>
<span class="sd">    with payment dates $t_1, \dots, t_n$.</span>

<span class="sd">    Moreover, let $t$ be the valuation date</span>
<span class="sd">    and $T=\{t_i \mid t \leq t_i \}$ if **include_value_date** is *True*</span>
<span class="sd">    else $T=\{t_i \mid t &lt; t_i \}$.</span>

<span class="sd">    Then the present value is given as</span>

<span class="sd">    $$v(t) = \sum_{t_i \in T} df(t, t_i) \cdot cf_i$$</span>

<span class="sd">    with $df(t, t_i)$, the discount factor discounting form $t_i$ to $t$.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">valuation_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">valuation_date</span> <span class="o">=</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">origin</span>

    <span class="c1"># filter flows</span>
    <span class="k">if</span> <span class="n">include_value_date</span><span class="p">:</span>
        <span class="n">pay_dates</span> <span class="o">=</span> \
            <span class="nb">list</span><span class="p">(</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">domain</span> <span class="k">if</span> <span class="n">valuation_date</span> <span class="o">&lt;=</span> <span class="n">d</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pay_dates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">domain</span> <span class="k">if</span> <span class="n">valuation_date</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">)</span>

    <span class="c1"># discount flows</span>
    <span class="n">value_flows</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pay_dates</span><span class="p">,</span> <span class="n">cashflow_list</span><span class="p">[</span><span class="n">pay_dates</span><span class="p">])</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">discount_curve</span><span class="o">.</span><span class="n">get_discount_factor</span><span class="p">(</span><span class="n">valuation_date</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span>
              <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">value_flows</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_yield_to_maturity</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span>
                          <span class="n">valuation_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">present_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; yield-to-maturity or effective interest rate</span>

<span class="sd">    :param cashflow_list: list of cashflows</span>
<span class="sd">    :param valuation_date: date to discount to</span>
<span class="sd">    :param present_value: price to meet by discounting</span>
<span class="sd">    :param kwargs: additional keyword used for constructing |ZeroRateCurve()|</span>
<span class="sd">    :return: `float` - as flat interest rate to discount all future cashflows</span>
<span class="sd">        in order to meet given **present_value**</span>

<span class="sd">    Let $cf_1 \dots cf_n$ be the list of cashflows</span>
<span class="sd">    with payment dates $t_1, \dots, t_n$.</span>

<span class="sd">    Moreover, let $t$ be the valuation date</span>
<span class="sd">    and $T=\{t_i \mid t \leq t_i \}$.</span>

<span class="sd">    Then the yield-to-maturity is the interest rate $y$ such that</span>
<span class="sd">    the **present_value** $\hat{v}$ is given as</span>

<span class="sd">    $$\hat{v} = \sum_{t_i \in T} df(t, t_i) \cdot cf_i$$</span>

<span class="sd">    with $df(t, t_i) = \exp(-y \cdot (t_i-t))$,</span>
<span class="sd">    the discount factor discounting form $t_i$ to $t$.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">valuation_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">valuation_date</span> <span class="o">=</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">origin</span>

    <span class="c1"># set error function</span>
    <span class="k">def</span> <span class="nf">err</span><span class="p">(</span><span class="n">current</span><span class="p">):</span>
        <span class="n">discount_curve</span> <span class="o">=</span> <span class="n">ZeroRateCurve</span><span class="p">([</span><span class="n">valuation_date</span><span class="p">],</span> <span class="p">[</span><span class="n">current</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">get_present_value</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">discount_curve</span><span class="p">,</span> <span class="n">valuation_date</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pv</span> <span class="o">-</span> <span class="n">present_value</span>

    <span class="c1"># run bracketing</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ytm</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_simple_bracketing</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ytm</span>


<span class="k">def</span> <span class="nf">get_interest_accrued</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">valuation_date</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; calculates interest accrued for rate cashflows</span>

<span class="sd">    :param cashflow_list: requires a `day_count` property</span>
<span class="sd">    :param valuation_date: calculation date</span>
<span class="sd">    :return: `float` - proportion of interest in current interest period</span>

<span class="sd">    Let $t$ be the valuation date</span>
<span class="sd">    and $s, e$ start resp. end date of current rate period,</span>
<span class="sd">    i.e. $s \leq t &lt; e$.</span>

<span class="sd">    Let $\tau$ be the day count function to calculate year fractions.</span>

<span class="sd">    Finally, let $cf$ be the next interest rate cashflow.</span>

<span class="sd">    The accrued interest until $t$ is given as</span>
<span class="sd">    $$cf_{accrued} =  cf \cdot \frac{\tau(s, t)}{\tau(s, e)}.$$</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">origin</span> <span class="o">&lt;</span> <span class="n">valuation_date</span> <span class="o">&lt;</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">CashFlowLegList</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">get_interest_accrued</span><span class="p">(</span><span class="n">leg</span><span class="p">,</span> <span class="n">valuation_date</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">legs</span><span class="p">)</span>
        <span class="c1"># only interest cash flows entitle to accrued interest</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="s1">&#39;day_count&#39;</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">domain</span> <span class="k">if</span> <span class="n">valuation_date</span> <span class="o">&gt;</span> <span class="n">d</span><span class="p">),</span>
                       <span class="n">default</span><span class="o">=</span><span class="n">cashflow_list</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
            <span class="nb">next</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">domain</span>
                        <span class="k">if</span> <span class="n">valuation_date</span> <span class="o">&lt;=</span> <span class="n">d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># use start and end rather than pay dates</span>
            <span class="k">if</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">pay_offset</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span> <span class="o">==</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">origin</span><span class="p">:</span>
                    <span class="n">last</span> <span class="o">-=</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">pay_offset</span>
                <span class="nb">next</span> <span class="o">-=</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">pay_offset</span>

            <span class="c1"># calculate remaining rate period proportion</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">day_count</span><span class="p">(</span><span class="n">valuation_date</span><span class="p">,</span> <span class="nb">next</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">=</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">day_count</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="nb">next</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cashflow_list</span><span class="p">[</span><span class="nb">next</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">remaining</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">0.</span>


<span class="k">def</span> <span class="nf">get_fair_rate</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">discount_curve</span><span class="p">,</span>
                  <span class="n">valuation_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">present_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; coupon rate to meet given value</span>

<span class="sd">    :param cashflow_list: list of cashflows</span>
<span class="sd">    :param discount_curve: discount factors are obtained from this curve</span>
<span class="sd">    :param valuation_date: date to discount to</span>
<span class="sd">    :param present_value: price to meet by discounting</span>
<span class="sd">    :return: `float` - the fair coupon rate as</span>
<span class="sd">        **fixed_rate** of a |RateCashFlowList()|</span>

<span class="sd">    Let $cf_i(c) = N_i \cdot \tau(s_i,e_i) \cdot c \cdot f(d_i)$</span>
<span class="sd">    be the $i$-th cashflow in the **cashflow_list**.</span>

<span class="sd">    Here, the fair rate is the fixed_rate $c=\hat{c}$ such that</span>
<span class="sd">    the **present_value** $\hat{v}$ is given as</span>

<span class="sd">    $$\hat{v} = \sum_{t_i \in T} df(t, t_i) \cdot cf_i(\hat{c})$$</span>

<span class="sd">    with $df(t, t_i)$, the discount factor discounting form $t_i$ to $t$.</span>

<span class="sd">    Note, **get_fair_rate** requires the **cashflow_list**</span>
<span class="sd">    to have an attribute **fixed_rate**</span>
<span class="sd">    which is perturbed to find the solution for $\hat{c}$.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">valuation_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">valuation_date</span> <span class="o">=</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">origin</span>

    <span class="c1"># todo: cashflow_list.payoff.fixed_rate</span>
    <span class="n">fixed_rate</span> <span class="o">=</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">fixed_rate</span>

    <span class="c1"># set error function</span>
    <span class="k">def</span> <span class="nf">err</span><span class="p">(</span><span class="n">current</span><span class="p">):</span>
        <span class="n">cashflow_list</span><span class="o">.</span><span class="n">fixed_rate</span> <span class="o">=</span> <span class="n">current</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">get_present_value</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">discount_curve</span><span class="p">,</span> <span class="n">valuation_date</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pv</span> <span class="o">-</span> <span class="n">present_value</span>

    <span class="c1"># run bracketing</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_simple_bracketing</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="mf">1e-7</span><span class="p">)</span>

    <span class="c1"># restore fixed rate</span>
    <span class="n">cashflow_list</span><span class="o">.</span><span class="n">fixed_rate</span> <span class="o">=</span> <span class="n">fixed_rate</span>
    <span class="k">return</span> <span class="n">par</span>


<span class="k">def</span> <span class="nf">get_par_rate</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">discount_curve</span><span class="p">,</span>
                 <span class="n">valuation_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">present_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; same as |get_fair_rate()| &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_fair_rate</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">discount_curve</span><span class="p">,</span> <span class="n">valuation_date</span><span class="p">,</span>
                         <span class="n">present_value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_basis_point_value</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">discount_curve</span><span class="p">,</span> <span class="n">valuation_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">delta_curve</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shift</span><span class="o">=.</span><span class="mi">0001</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; basis point value (bpv),</span>
<span class="sd">    i.e. value change by one interest rate shifted one basis point</span>

<span class="sd">    :param cashflow_list: list of cashflows</span>
<span class="sd">    :param discount_curve: discount factors are obtained from this curve</span>
<span class="sd">    :param valuation_date: date to discount to</span>
<span class="sd">    :param delta_curve: curve which will be shifted</span>
<span class="sd">    :param shift: shift size to derive bpv</span>
<span class="sd">    :return: `float` - basis point value (bpv)</span>

<span class="sd">    Let $v(t, r)$ be the present value of the given **cashflow_list**</span>
<span class="sd">    depending on interest rate curve $r$</span>
<span class="sd">    which can be used as forward curve to estimate float rates</span>
<span class="sd">    or as zero rate curve to derive discount factors (or both).</span>

<span class="sd">    Then, with **shift_size** $s$, the bpv is given as</span>

<span class="sd">    $$\Delta(t) = 0.0001 \cdot \frac{v(t, r + s) - v(t, r)}{s}$$</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">CashFlowLegList</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">get_basis_point_value</span><span class="p">(</span>
            <span class="n">leg</span><span class="p">,</span> <span class="n">discount_curve</span><span class="p">,</span> <span class="n">valuation_date</span><span class="p">,</span> <span class="n">delta_curve</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">legs</span><span class="p">)</span>
    <span class="n">buckets</span> <span class="o">=</span> <span class="n">get_bucketed_delta</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">discount_curve</span><span class="p">,</span> <span class="n">valuation_date</span><span class="p">,</span>
                                 <span class="n">delta_curve</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">buckets</span><span class="p">)</span>


<div class="viewcode-block" id="get_bucketed_delta"><a class="viewcode-back" href="../../api/Derivate.html#Derivate.session2_exercise4.get_bucketed_delta">[docs]</a><span class="k">def</span> <span class="nf">get_bucketed_delta</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">discount_curve</span><span class="p">,</span> <span class="n">valuation_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">delta_curve</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delta_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">shift</span><span class="o">=.</span><span class="mi">0001</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; list of bpv delta for partly shifted interest rate curve</span>

<span class="sd">    :param cashflow_list: list of cashflows</span>
<span class="sd">    :param discount_curve: discount factors are obtained from this curve</span>
<span class="sd">    :param valuation_date: date to discount to</span>
<span class="sd">    :param delta_curve: curve which will be shifted</span>
<span class="sd">    :param delta_grid: grid dates to build partly shifts</span>
<span class="sd">    :param shift: shift size to derive bpv</span>
<span class="sd">    :return: `list(float)` - basis point value for each **delta_grid** point</span>

<span class="sd">    Let $v(t, r)$ be the present value of the given **cashflow_list**</span>
<span class="sd">    depending on interest rate curve $r$</span>
<span class="sd">    which can be used as forward curve to estimate float rates</span>
<span class="sd">    or as zero rate curve to derive discount factors (or both).</span>

<span class="sd">    Then, with **shift_size** $s$ and shifting $s_j$,</span>

<span class="sd">    $$\Delta_j(t) = 0.0001 \cdot \frac{v(t, r + s_j) - v(t, r)}{s}$$</span>

<span class="sd">    and the full bucketed delta vector is</span>
<span class="sd">    $\big(\Delta_1(t), \Delta_2(t), \dots, \Delta_{m-1}(t) \Delta_m(t)\big)$.</span>

<span class="sd">    Overall the shifting $s_1, \dots s_n$ is a partition of the unity,</span>
<span class="sd">    i.e. $\sum_{j=1}^m s_j = s$.</span>

<span class="sd">    Each $s_j$ for $i=2, \dots, m-1$ is a function of the form of an triangle,</span>
<span class="sd">    i.e. for a **delta_grid** $t_1, \dots, t_m$</span>

<span class="sd">    .. math::</span>
<span class="sd">        :nowrap:</span>

<span class="sd">        \[</span>
<span class="sd">        s_j(t) =</span>
<span class="sd">        \left\{</span>
<span class="sd">        \begin{array}{cl}</span>
<span class="sd">            0 &amp; \text{ for } t &lt; t_{j-1} \\</span>
<span class="sd">            s \cdot \frac{t-t_{j-1}}{t_j-t_{j-1}}</span>
<span class="sd">                &amp; \text{ for } t_{j-1} \leq t &lt; t_j \\</span>
<span class="sd">            s \cdot \frac{t_{j+1}-t}{t_{j+1}-t_j}</span>
<span class="sd">                &amp; \text{ for } t_j \leq t &lt; t_{j+1} \\</span>
<span class="sd">            0 &amp; \text{ for } t_{j+1} \leq t \\</span>
<span class="sd">        \end{array}</span>
<span class="sd">        \right.</span>
<span class="sd">        \]</span>

<span class="sd">    while</span>

<span class="sd">    .. math::</span>
<span class="sd">        :nowrap:</span>

<span class="sd">        \[</span>
<span class="sd">        s_1(t) =</span>
<span class="sd">        \left\{</span>
<span class="sd">        \begin{array}{cl}</span>
<span class="sd">            s &amp; \text{ for } t &lt; t_1 \\</span>
<span class="sd">            s \cdot \frac{t_2-t}{t_2-t_1} &amp; \text{ for } t_1 \leq t &lt; t_2 \\</span>
<span class="sd">            0 &amp; \text{ for } t_2 \leq t \\</span>
<span class="sd">        \end{array}</span>
<span class="sd">        \right.</span>
<span class="sd">        \]</span>

<span class="sd">    and</span>

<span class="sd">    .. math::</span>
<span class="sd">        :nowrap:</span>

<span class="sd">        \[</span>
<span class="sd">        s_m(t) =</span>
<span class="sd">        \left\{</span>
<span class="sd">        \begin{array}{cl}</span>
<span class="sd">            0 &amp; \text{ for } t &lt; t_{m-1} \\</span>
<span class="sd">            s \cdot \frac{t-t_{m-1}}{t_m-t_{m-1}}</span>
<span class="sd">                &amp; \text{ for } t_{m-1} \leq t &lt; t_m \\</span>
<span class="sd">            s &amp; \text{ for } t_m \leq t \\</span>
<span class="sd">        \end{array}</span>
<span class="sd">        \right.</span>
<span class="sd">        \]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">CashFlowLegList</span><span class="p">):</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">get_bucketed_delta</span><span class="p">(</span>
            <span class="n">leg</span><span class="p">,</span> <span class="n">discount_curve</span><span class="p">,</span> <span class="n">valuation_date</span><span class="p">,</span> <span class="n">delta_curve</span><span class="p">,</span> <span class="n">delta_grid</span><span class="p">,</span> <span class="n">shift</span>
        <span class="p">)</span> <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="n">cashflow_list</span><span class="o">.</span><span class="n">legs</span><span class="p">)</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">buckets</span><span class="p">)))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">buckets</span><span class="p">)</span>

    <span class="n">pv</span> <span class="o">=</span> <span class="n">get_present_value</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">discount_curve</span><span class="p">,</span> <span class="n">valuation_date</span><span class="p">)</span>
    <span class="n">delta_curve</span> <span class="o">=</span> <span class="n">discount_curve</span> <span class="k">if</span> <span class="n">delta_curve</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">delta_curve</span>

    <span class="c1"># check if curve is CashRateCurve</span>
    <span class="n">basis_point_curve_type</span> <span class="o">=</span> <span class="n">CashRateCurve</span> \
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delta_curve</span><span class="p">,</span> <span class="n">CashRateCurve</span><span class="p">)</span> <span class="k">else</span> <span class="n">ZeroRateCurve</span>

    <span class="k">if</span> <span class="n">delta_grid</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">delta_grid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta_grid</span><span class="p">,)</span>
            <span class="n">shifts</span> <span class="o">=</span> <span class="p">([</span><span class="n">shift</span><span class="p">],)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">delta_grid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta_grid</span><span class="p">,</span> <span class="n">delta_grid</span><span class="p">)</span>
            <span class="n">shifts</span> <span class="o">=</span> <span class="p">([</span><span class="n">shift</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="p">[</span><span class="n">delta_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">delta_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">mids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">delta_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">delta_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">delta_grid</span><span class="p">[</span><span class="mi">2</span><span class="p">:])))</span>
            <span class="n">last</span> <span class="o">=</span> <span class="p">[</span><span class="n">delta_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">delta_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

            <span class="n">grid</span> <span class="o">=</span> <span class="p">[</span><span class="n">first</span><span class="p">]</span> <span class="o">+</span> <span class="n">mids</span> <span class="o">+</span> <span class="p">[</span><span class="n">last</span><span class="p">]</span>
            <span class="n">shifts</span> <span class="o">=</span> <span class="p">[[</span><span class="n">shift</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]]</span> <span class="o">+</span> \
                     <span class="p">[[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">mids</span><span class="p">)</span> <span class="o">+</span> <span class="p">[[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="p">([</span><span class="n">delta_curve</span><span class="o">.</span><span class="n">origin</span><span class="p">],)</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="p">([</span><span class="n">shift</span><span class="p">],)</span>

    <span class="n">buckets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">shifts</span><span class="p">):</span>
        <span class="n">shifted_curve</span> <span class="o">=</span> <span class="n">delta_curve</span> <span class="o">+</span> <span class="n">basis_point_curve_type</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="c1"># todo: cashflow_list.payoff_model.forward_curve</span>
        <span class="n">fwd_curve</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="s1">&#39;forward_curve&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fwd_curve</span> <span class="o">==</span> <span class="n">delta_curve</span><span class="p">:</span>
            <span class="c1"># replace delta_curve by shifted_curve</span>
            <span class="n">cashflow_list</span><span class="o">.</span><span class="n">forward_curve</span> <span class="o">=</span> <span class="n">shifted_curve</span>
        <span class="k">if</span> <span class="n">delta_curve</span> <span class="o">==</span> <span class="n">discount_curve</span><span class="p">:</span>
            <span class="n">sh</span> <span class="o">=</span> <span class="n">get_present_value</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">shifted_curve</span><span class="p">,</span>
                                   <span class="n">valuation_date</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sh</span> <span class="o">=</span> <span class="n">get_present_value</span><span class="p">(</span><span class="n">cashflow_list</span><span class="p">,</span> <span class="n">discount_curve</span><span class="p">,</span>
                                   <span class="n">valuation_date</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fwd_curve</span> <span class="o">==</span> <span class="n">delta_curve</span><span class="p">:</span>
            <span class="c1"># restore delta_curve by shifted_curve</span>
            <span class="n">cashflow_list</span><span class="o">.</span><span class="n">forward_curve</span> <span class="o">=</span> <span class="n">delta_curve</span>

        <span class="n">buckets</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sh</span> <span class="o">-</span> <span class="n">pv</span><span class="p">)</span> <span class="o">/</span> <span class="n">shift</span> <span class="o">*</span> <span class="o">.</span><span class="mi">0001</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">buckets</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Derivate</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Releases</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;Jan-Philipp Hoffmann.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>